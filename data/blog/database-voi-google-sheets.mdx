---
title: Database v·ªõi Google sheets
date: '2022-08-22'
tags: ['aws', 'crawler', 'lambda', 'automation', 'googledocs', 'database', 'tutorial']
draft: false
authors: ['mau']
images: ['/static/images/ogps/currency-crawler-2.png']
summary: 'H∆∞·ªõng d·∫´n t·∫°o ·ª©ng d·ª•ng crawl d·ªØ li·ªáu s·ª≠ d·ª•ng Google sheets l√†m database ch√≠nh v√† nh·ªØng ƒëi·ªÉu c·∫ßn ch√∫ √Ω'
---

![Currency Crawler](/static/images/ogps/currency-crawler-2.png)

<TOCInline toc={props.toc} asDisclosure />

## TL;DR

- D√πng Google spreadsheet l√†m c∆° s·ªü d·ªØ li·ªáu thay cho DynamoDB trong b√†i vi·∫øt [Crawl d·ªØ li·ªáu t·ª∑ gi√° h·ªëi ƒëo√°i v·ªõi AWS Lambda v√† DynamoDB (Over engineer version)](/blog/crawl-du-lieu-ty-gia-hoi-doai)
- B·∫°n c√≥ th·ªÉ truy c·∫≠p "production database" c·ªßa ·ª©ng d·ª•ng n√†y t·∫°i [google sheet n√†y](https://docs.google.com/spreadsheets/d/1nzKN3NSTh_AVQlSOm5Zv4CQZlejkPpHw3FkOm6T1zio/edit?usp=sharing)

## Y√™u c·∫ßu

V·∫´n l√† y√™u c·∫ßu l·∫•y d·ªØ li·ªáu t·ª∑ gi√° h·ªëi ƒëo√°i c·ªßa 3 ng√¢n h√†ng Vi·ªát Nam nh∆∞ ƒë√£ tr√¨nh b√†y ·ªü [b√†i vi·∫øt tr∆∞·ªõc](/blog/crawl-du-lieu-ty-gia-hoi-doai).
D√π kh√¥ng ƒë∆∞·ª£c tr·∫£ ti·ªÅn nh∆∞ng khi nghƒ© ƒë·∫øn vi·ªác m·∫π c·ªßa ch√°u t√¥i l·ªç m·ªç download file csv t·ª´ API gateway t√¥i v·∫´n th·∫•y h∆°i c·∫Øn r·ª©t.
Gi√∫p ng∆∞·ªùi th√¨ gi√∫p cho ch√≥t, th√™m n·ªØa th√°ng sau ch√°u m·ªõi ƒëi m·∫´u gi√°o n√™n t√¥i ƒë√†nh l√†m ph·∫ßn giao di·ªán friendly v·ªõi ng∆∞·ªùi d√πng h∆°n.

üí° V√† ƒë√¢y l√† diagram c·ªßa h·ªá th·ªëng m·ªõi

![Currency crawler diagram v2](/static/images/assets/currency-crawler.drawio.png)

Google sheets l√† gi·∫£i ph√°p r·∫•t t·ªët v√¨ n√≥ ƒë√°p ·ª©ng ƒë∆∞·ª£c 2 y√™u c·∫ßu:

- Th√¢n thi·ªán v·ªõi ng∆∞·ªùi d√πng (ch·ªã t√¥i)
- C√≥ th·ªÉ l√†m database ü§•

<div
  className="bg-orange-100 border-t-4 border-orange-500 rounded-b text-orange-900 px-4 py-3 shadow-md"
  role="alert"
>
  <div className="flex">
    <div>
      <ul>
        <li className="text-sm">Google sheets kh√¥ng c√≥ t√≠nh m·ªü r·ªông (scalability)</li>
        <li className="text-sm">
          Ch·ªâ c√≥ th·ªÉ l∆∞u tr·ªØ 5 tri·ªáu √¥ t√≠nh, kh√¥ng c√≥ truy v·∫•n ho·∫∑c truy v·∫•n join v√† c√≥ gi·ªõi h·∫°n s·ªë
          l·∫ßn g·ªçi API.
        </li>
      </ul>
    </div>
  </div>
</div>

## Tri·ªÉn khai

### Google sheets

- T·∫°o google sheets m·ªõi. L∆∞u l·∫°i sheet id c·ªßa b·∫£ng t√≠nh.

![t·∫°o google sheet](/static/images/assets/002-1.png)

- T·∫°o m·ªôt [project m·ªõi tr√™n GCP](https://console.cloud.google.com/projectcreate?)

![t·∫°o project m·ªõi tr√™n gcp](/static/images/assets/002-2.png)

- Enable [google sheet api](https://console.cloud.google.com/apis/library/sheets.googleapis.com) cho project

![K√≠ch ho·∫°t Google sheet API](/static/images/assets/002-3.png)

- Crawler c·∫ßn s·ª≠ d·ª•ng api spreadsheet append n√™n kh√¥ng th·ªÉ s·ª≠ d·ª•ng ki·ªÉu x√°c th·ª±c v·ªõi API key, l·ª±a ch·ªçn ƒë∆°n gi·∫£n nh·∫•t l√† s·ª≠
  d·ª•ng service account.

- T·∫°o service account v√† t·∫°o key cho service account

![t·∫°o service account v√† key cho service account](/static/images/assets/002-4.png)

- Save key d∆∞·ªõi t√™n file credentials.json ·ªü trong th∆∞ m·ª•c lambda function

![l∆∞u l·∫°i d∆∞·ªõi t√™n credential.json](/static/images/assets/002-5-1.png)

- Chia s·∫ª quy·ªÅn s·ª≠a trang t√≠nh v·ªõi email c·ªßa service account

![chia s·∫ª quy·ªÅn s·ª≠a trang t√≠nh v·ªõi email c·ªßa service account](/static/images/assets/002-5.png)

### Sam template & Lambda function

- S·ª≠a l·∫°i file template, xo√° b·ªè nh·ªØng resource kh√¥ng c·∫ßn d√πng t·ªõi nh∆∞
  - Get CSV function
  - HTTP API
  - DynamoDB
  - Th√™m c√°c bi·∫øn m√¥i tr∆∞·ªùng cho h√†m Crawler

```yaml:template.yaml
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  currency-crawler

  Sample SAM Template for currency-crawler

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 300
    Environment:
      Variables:
        SPREADSHEET_ID: '1nzKN3NSTh_AVQlSOm5Zv4CQZlejkPpHw3FkOm6T1zio'
        RANGE_NAME: 'A1:H1'
        VALUE_INPUT_OPTION: 'USER_ENTERED'


Resources:
  CurrencyCrawlFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: currency/
      Handler: app.crawl
      Runtime: python3.9
      Architectures:
        - x86_64
      Events:
        InvocationLevel:
          Type: Schedule
          Properties:
            Schedule: cron(0 11 ? * MON-FRI *) # All scheduled events use UTC+0 time zone

Outputs:
  CurrencyCrawlFunction:
    Description: "Currency Crawler Lambda Function ARN"
    Value: !GetAtt CurrencyCrawlFunction.Arn
  CurrencyCrawlFunctionIamRole:
    Description: "Implicit IAM Role created for Currency Crawler function"
    Value: !GetAtt CurrencyCrawlFunctionRole.Arn
```

- S·ª≠a l·∫°i h√†m crawler c·ªßa c√°c banks, chuy·ªÉn t·ª´ ki·ªÉu decimal -> float cho c√°c t·ª∑ gi√° (DynamoDB ch·ªâ nh·∫≠n ki·ªÉu Decimal c√≤n google sheet th√¨ kh√¥ng)

```python:app.py
from datetime import date
from mbb import get_record as get_mbb_record
from scb import get_record as get_scb_record
from bidv import get_record as get_bidv_record
import json
from config import logger
from utils import append_to_db, format_record

def crawl(event, context):
    try:
        requested_date_str = date.today().strftime("%d/%m/%Y")
        mbb_record = get_mbb_record(requested_date_str)
        append_to_db(format_record(mbb_record))

        bidv_record = get_bidv_record(requested_date_str)
        append_to_db(format_record(bidv_record))

        scb_record = get_scb_record(requested_date_str)
        append_to_db(format_record(scb_record))

        logger.info("Inserted to Google sheet")
    except Exception as e:
        logger.error(e)
        raise e

    return {
        "statusCode": 200,
        "body": json.dumps({
            "message": "Done! Currencies data imported",
        }),
    }
```

```python:banks.py
record[currency] = Decimal(ck) -> record[currency] = float(ck)
```

- Xo√° c√°c h√†m t∆∞∆°ng t√°c v·ªõi DynamoDB, thay v√†o ƒë√≥ l√† c√°c h√†m append d·ªØ li·ªáu v√†o google sheet

```txt:requirements.txt
requests
bs4
google-api-python-client
google-auth-httplib2
google-auth-oauthlib
```

```python:utils.py
import os
import google.auth
from googleapiclient.discovery import build
from googleapiclient.errors import HttpError

os.environ['GOOGLE_APPLICATION_CREDENTIALS'] = './credentials.json'
SPREADSHEET_ID = os.environ.get('SPREADSHEET_ID')
RANGE_NAME = os.environ.get('RANGE_NAME')
VALUE_INPUT_OPTION = os.environ.get('VALUE_INPUT_OPTION')

def append_to_db(values):
    creds, _ = google.auth.default()
    try:
        service = build('sheets', 'v4', credentials=creds)
        # ["2022/03/17", "MBB", "23020", "25876", "198.31", "16962", "2996", "17169"]
        body = {
            'values': [values]
        }
        result = service.spreadsheets().values().append(
            spreadsheetId=SPREADSHEET_ID, range=RANGE_NAME,
            valueInputOption=VALUE_INPUT_OPTION, body=body).execute()
        print(f"{(result.get('updates').get('updatedCells'))} cells appended.")
        return result

    except HttpError as error:
        print(f"An error occurred: {error}")
        return error

# date bank USD	EUR	JPY	AUD	HKD	SGD
def format_record(record):
    arr = []
    arr.append(record['date'])
    arr.append(record['bank'])
    arr.append(record['USD'])
    arr.append(record['EUR'])
    arr.append(record['JPY'])
    arr.append(record['AUD'])
    arr.append(record['HKD'])
    arr.append(record['SGD'])
    return arr
```

### Test & Validate & Build & Deploy

```shell:shell
# test function
sam local invoke "CurrencyCrawlFunction" -e events/event.json

# validate SAM template
sam validate --profile vntechies --region ap-southeast-1

# build package
sam build

# deploy
sam deploy --guided --profile vntechies
```

Demo ·ªü local b·∫±ng sam local invoke

https://giphy.com/gifs/gifmLy13vYZVH2mzJQ

B·∫±ng vi·ªác lo·∫°i b·ªè DynamoDB, API gateway kh·ªèi h·ªá th·ªëng, nh·ªØng vi·ªác c·∫ßn ho√†n thi·ªán c≈©ng ƒë∆∞·ª£c l∆∞·ª£c b·ªè

<small>Th·ª© m√† t√¥i v·∫´n s·∫Ω kh√¥ng l√†m v√¨ t√¥i kh√¥ng ƒë∆∞·ª£c tr·∫£ ti·ªÅn cho vi·ªác n√†y üòÇ</small>

1. X·ª≠ l√Ω l·ªói cho c√°c HTTP requests t·ªõi c√°c site c·ªßa banks ƒë·ªÅ ph√≤ng tr∆∞·ªùng h·ª£p bank n√†o ƒë√≥ b·∫≠t maintainance mode, thay ƒë·ªïi giao di·ªán, handle dead letter queue
2. ~~ƒê√°nh index cho b·∫£ng Currency, s·ª≠ d·ª•ng query thay v√¨ scan ƒë·ªÉ gi·∫£m chi ph√≠ (n·∫øu ph√°t sinh), s·ª≠ d·ª•ng DynamoDB update expressions x·ª≠ l√Ω vi·ªác ghi ƒë√® d·ªØ li·ªáu n·∫øu c√≥~~
3. ~~S·ª≠ d·ª•ng Authentication cho c√°c APIs~~
4. Headless browser tr√™n Lambda
5. Unit tests v√† integration tests, t·∫°o c√°c m√¥i tr∆∞·ªùng ph√°t tri·ªÉn kh√°c (dev, staging,...)
6. ~~Handle file size limit t·ª´ Lambda (6MB). C≈©ng l√† l·ªùi nh·∫Øn nh·ªß v·ªõi ch·ªã g√°i, **ƒë·ª´ng download d·ªØ li·ªáu > 12 th√°ng.** üôÑ~~

V·∫≠y l√† ch√°u t√¥i c√≥ th√™m th·ªùi gian ch∆°i v·ªõi m·∫π, gi·∫£i ph√°p c·ªìng k·ªÅnh ƒë√£ ƒë∆∞·ª£c thu g·ªçn b·ªõt, th√¢n thi·ªán h∆°n v·ªõi ng∆∞·ªùi d√πng cu·ªëi ü§ü

H√£y ƒë·ªÉ l·∫°i ƒë√°nh gi√°, comment n·∫øu b·∫°n c·∫£m th·∫•y tutorial n√†y h·ªØu √≠ch (ho·∫∑c vui) nh√©! üò¨

## Reference

- [Python Quickstart](https://developers.google.com/sheets/api/quickstart/python)
- [Service account credentials](https://developers.google.com/workspace/guides/create-credentials#service-account)
- [Method: spreadsheets.values.append](https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets.values/append)

## VNTechies Dev Blog

Kho t√†i nguy√™n m√£ ngu·ªìn m·ªü v·ªõi s·ª© m·ªánh ƒë√†o t·∫°o ki·∫øn th·ª©c, ƒë·ªãnh h∆∞·ªõng ngh·ªÅ nghi·ªáp cho c·ªông ƒë·ªìng Cloud ‚òÅÔ∏è DevOps üöÄ

[![Facebook page](https://i.imgur.com/YxfhUTS.png)](https://www.facebook.com/vntechies)

Tham gia group [VNTechies - Cloud ‚òÅÔ∏è / DevOps üöÄ](https://www.facebook.com/groups/acevntechies) n·∫øu b·∫°n mu·ªën giao l∆∞u v·ªõi c·ªông ƒë·ªìng v√† c·∫≠p nh·∫≠t c√°c th√¥ng tin m·ªõi nh·∫•t v·ªÅ Cloud v√† DevOps.

- Website: https://vntechies.dev
- Github repository: https://github.com/vntechies
- Facebook page: https://facebook.com/vntechies

[![Discord banner](https://images.viblo.asia/c8c4a473-c08d-45a3-be57-821781c1c256.png)](https://discord.com/invite/k2uDgd7NZ4)

Anh ch·ªã em h√£y follow/·ªßng h·ªô VNTechies ƒë·ªÉ c·∫≠p nh·∫≠t nh·ªØng th√¥ng tin m·ªõi nh·∫•t v·ªÅ Cloud v√† DevOps nh√©!
