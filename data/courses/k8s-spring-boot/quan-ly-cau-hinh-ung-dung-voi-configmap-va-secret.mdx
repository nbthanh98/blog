---
title: Quản lý cấu hình ứng dụng với ConfigMap và Secret trong Kubernetes
date: '2022-12-10'
tags: ['api', 'rest-api', 'springboot', 'kubernetes']
series: ['k8s-spring-boot']
draft: false
authors: ['thanhnb']
images: ['/static/images/ogps/k8s-springboot.png']
summary: 'Trong bài này chúng ta sẽ tìm hiểu cách quản lý cấu hình ứng dụng với ConfigMap và Secret trong Kubernetes.'
index: 5
---

<TOCInline toc={props.toc} asDisclosure />

## 1. Giới thiệu chung

Trong những bài trước những cấu hình của ứng dụng như: thông tin database (username, password) hoặc thông tin URI gọi đến các ứng dụng khác được inject vào bên trong container dưới dạng biến môi trường. Thông thường các ứng dụng thường tách biệt code và cấu hình ứng dụng để dễ dàng quản lý và cấu hình cho ứng dụng theo từng môi trường.

Trong bài viết này chúng ta cùng nhau tìm hiểu hai đối tượng giúp lưu trữ những cấu hình đó là ConfigMap và Secret trong Kubernetes. Để tránh cho bài viết này bị trùng lặp thì mình sẽ chỉ cấu hình Students-service và Courses-service cũng sẽ cấu hình tương tự.

## 2. ConfigMap và Secret trong Kubernetes là gì?

![ConfigMap và Secret trong Kubernetes](/static/images/assets/configmap-secret-k8s.png)

**ConfigMap** đối tượng trong Kubernetes giúp lưu trữ các thông tin cấu hình của ứng dụng dưới dạng key-value. ConfigMap thường được dùng để cấu hình những thông tin ít nhạy cảm và data cấu hình trong ConfigMap hiển thị dưới dạng plain text. Pods của ứng dụng có thể lấy thông tin cấu hình từ ConfigMap giống như các biến môi trường, command-line hoặc các file cấu hình dưới dạng volume. ConfigMap cần triển khai trước khi triển khai ứng dụng nếu không các pod của ứng dụng sẽ không khởi chạy được vì không tìm thấy ConfigMap và pod chỉ có thể đọc được ConfigMap trên cùng namespace. Bạn có thể tìm hiểu thêm ConfigMap tại [trang web chính thức của Kubernetes](https://kubernetes.io/docs/concepts/configuration/configmap/).

**Secret** là đối tượng trong Kubernetes giúp lưu trữ các thông tin cấu hình của ứng dụng dưới dạng key-value. Secret thì thường được dùng để cấu hình các thông tin nhạy cảm như: thông tin database (username, password), thông tin secretKey, accessKey,... và các thông tin cấu hình này sẽ được mã hóa bằng base64. Secret phải được triển khai trước khi triển khai ứng dụng nếu không pod của ứng dụng sẽ không khỏi chạy được vì không tìm thấy Secret và pod chỉ có thể đọc được Secret trên cùng namespace. Bạn có thể tìm hiểu thêm Secret tại [trang web chính thức của Kubernetes](https://kubernetes.io/docs/concepts/configuration/secret/).

## 3. Tạo ConfigMap và triển khai ConfigMap trên Kubernetes

### Tạo ConfigMap cho ứng dụng

ConfigMap là đối tượng khá đơn giản để định nghĩa trong Kubernetes, các thông tin cấu hình thì định nghĩa dưới trường `data` theo format key=value và tên của ConfigMap thì định nghĩa ở trường `metadata.name`. Dưới đây là tạo file cấu hình students-cm.yaml cho Students-service:

```YAML:k8s/students-cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: students-cm
data:
  SERVER_PORT: "8080"
  MYSQL_URL: "jdbc:mysql://mysql:3306/students"
  MYSQL_USERNAME: "students"
  MYSQL_PASSWORD: "VNTechies2023"
```

Tạo file cấu hình courses-cm.yaml cho Courses-service:

```YAML:k8s/courses-cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: courses-cm
data:
  SERVER_PORT: "8080"
  MYSQL_URL: "jdbc:mysql://mysql:3306/courses"
  MYSQL_USERNAME: "courses"
  MYSQL_PASSWORD: "VNTechies2023"
  STUDENTS_URI: "http://students-service"
```

Các thành phần trong ConfigMap:

| Tên             | Định nghĩa                                                                                         |
| --------------- | -------------------------------------------------------------------------------------------------- |
| `apiVersion`    | Version của Kubernetes API mà bạn sử dụng để tạo object/resource. Hai file cấu hình trên là: `v1`. |
| `kind`          | Loại object/resource của Kubernetes. Hai file cấu hình trên là: `ConfigMap`.                       |
| `metadata.name` | Định nghĩa tên của ConfigMap. Hai file cấu hình trên là: `students-cm` và `courses-cm`.            |
| `data`          | Chứa các thông tin cấu hình của ứng dụng theo format key=value.                                    |

### Triển khai ConfigMap trên Kubernetes

Triển khai ConfigMap trên Kubernetes bằng lệnh: `kubectl apply -f <file-path>`

```shell
kubectl apply -f students-cm.yaml
configmap/students-cm created

kubectl apply -f courses-cm.yaml
configmap/courses-cm created

# Lấy danh sách ConfigMap
kubectl get configmap
NAME                  DATA   AGE
students-cm           4      58s
courses-cm            5      48s
```

Lấy chi tiết ConfigMap bằng lệnh: `kubectl describe cm/<CONFIGMAP_NAME>`

```shell
kubectl describe cm/students-cm
Name:         students-cm
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
MYSQL_PASSWORD:
----
VNTechies2023
MYSQL_URL:
----
jdbc:mysql://mysql:3306/students
MYSQL_USERNAME:
----
students
SERVER_PORT:
----
8080

BinaryData
====

Events:  <none>
```

### Cấu hình sử dụng ConfigMap trong Pods

Khi triển khai ConfigMap thành công thì Pods có thể sử dụng các thông tin cấu hình bên trong ConfigMap bằng một số cách thông qua: environment variables, command line arguments hoặc mounted files. Các cách lấy cấu hình bên trong ConfigMap có một số đặc điểm như sau:

- **Environment variables**: Thường sử dụng cho các thông tin cấu hình không quá lớn (< 1MB). Khi thay đổi thông tin cấu hình ở ConfigMap thì các Pod **CẦN** restart lại để cập nhật thông tin cấu hình mới nhất.
- **Mounted files**: Sẽ mount file cấu hình dưới dạng volume và thường dùng cho các file cấu hình lớn. Khi thay đổi thông tin cấu hình ở ConfigMap thì các Pod **KHÔNG CẦN** restart lại để cập nhật thông tin cấu hình mới nhất.

### Lấy thông tin cấu hình bên bên trong ConfigMap thông qua biến môi trường

Định nghĩa tên ConfigMap ở trường `spec.containers.envFrom.configMapRef`. Ở file cấu hình trên đang lấy thông tin cấu hình ở ConfigMap có tên là students-cm và tất cả thông tin cấu hình sẽ được inject vào bên trong Pod dưới dạng biến môi trường. Cấu hình sẽ tương tự đối với Courses-service.

```YAML:k8s/students-deployment-configMap-env.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: students-service
  labels:
    app: students-service
spec:
  selector:
    matchLabels:
      app: students-service
  replicas: 3
  template:
    metadata:
      labels:
        app: students-service
    spec:
      containers:
        - name: students-service
          image: thanhnb1/students-service:latest

          # Định nghĩa lấy thông tin cấu hình ở ConfigMap nào.
          envFrom:
            - configMapRef:
                # Tên ConfigMap
                name: students-cm
          ports:
            - containerPort: 8080
      restartPolicy: Always
```

Bạn cũng có thể lấy từng thông tin cấu hình của ConfigMap và inject vào trong pod dưới dang biến môi trường như sau:

```YAML:k8s/students-deployment-configMap-env2.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: students-service
  labels:
    app: students-service
spec:
  selector:
    matchLabels:
      app: students-service
  replicas: 3
  template:
    metadata:
      labels:
        app: students-service
    spec:
      containers:
        - name: students-service
          image: thanhnb1/students-service:latest
          env:
              # Tên biến môi trường.
            - name: SERVER_PORT
              valueFrom:
                # Lấy biến môi trường từ ConfigMap.
                configMapKeyRef:
                  # Tên ConfigMap.
                  name: students-cm
                  # Tên key sẽ lấy được định nghĩa ở phần `data` trong ConfigMap.
                  key: SERVER_PORT
            - name: MYSQL_URL
              valueFrom:
                configMapKeyRef:
                  name: students-cm
                  key: MYSQL_URL
            - name: MYSQL_USERNAME
              valueFrom:
                configMapKeyRef:
                  name: students-cm
                  key: MYSQL_USERNAME
            - name: MYSQL_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: students-cm
                  key: MYSQL_PASSWORD
                 ports:
                   - containerPort: 8080
      restartPolicy: Always
```

Lấy các biến môi trường bên trong Pod:

```shell
# 1. Lâý danh sách pods:
kubectl get pods
NAME                                READY   STATUS    RESTARTS        AGE
students-service-6698fcb486-8lfzt   1/1     Running   0               4m25s
students-service-6698fcb486-xtk5n   1/1     Running   0               4m25s
students-service-6698fcb486-mlzk6   1/1     Running   0               4m25s

# 2. Lấy biên môi trường bên trong pod:
kubectl exec -it po/students-service-6698fcb486-mlzk6 sh -- env

...
...
# Đây là các thông tin cấu hình lấy từ ConfigMap
MYSQL_URL=jdbc:mysql://mysql:3306/students
MYSQL_USERNAME=students
SERVER_PORT=8080
MYSQL_PASSWORD=VNTechies2023
MYSQL_SERVICE_PORT=3306
...
```

### Lấy thông tin cấu hình bên bên trong ConfigMap thông qua Mounted Volume

Khi ứng dụng Spring boot khởi chạy thì sẽ nó sẽ tự động tìm và load file cấu hình `application.properties` hoặc `application.yaml`. Nếu bạn muốn chỉ định một file cấu hình khác (chính là file cấu hình mà sẽ ta mounted vào container của ứng dụng) thì có thể chỉ định đường dẫn đến file đó bằng cách thêm tham số `--spring.config.location=file:<path-config-file>` khi chạy file jar trong Dockerfile.

```Dockerfile:students/Dockerfile
FROM adoptopenjdk/openjdk11:latest
WORKDIR /workspace
COPY target/*-SNAPSHOT.jar /workspace/app.jar
ENV TZ="Asia/Ho_Chi_Minh"
EXPOSE 8080
ENTRYPOINT ["java","-jar","/workspace/app.jar", "--spring.config.location=file:/config/application.yaml"]
```

Tạo file students-cm-volume.yaml để tạo cấu hình ConfigMap cho ứng dụng:

```YAML:k8s/students-cm-volume.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: students-cm
data:
  application.yaml: |-
    server:
      port: 8080

    spring:
      datasource:
        driverClassName: com.mysql.jdbc.Driver
        url: jdbc:mysql://mysql:3306/students
        username: students
        password: VNTechies2023
      jpa:
        hibernate.ddl-auto: update
        generate-ddl: true
        show-sql: false
```

ConfigMap có thể được mounted vào bên trong container giống như sử dụng volume. Thông tin cấu hình bên trong ConfigMap sẽ được mounted vào bên trong container thông qua trường `volumeMounts`.

```YAML:k8s/students-deployment-configmap-volume.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: students-service
  labels:
    app: students-service
spec:
  selector:
    matchLabels:
      app: students-service
  replicas: 3
  template:
    metadata:
      labels:
        app: students-service
    spec:
      containers:
        - name: students-service
          image: thanhnb1/students-service:latest
          ports:
            - containerPort: 8080
          volumeMounts:

              # File "application.yaml" trong ConfigMap sẽ được mounted vào folder "/config" bên trong contaienr.
            - mountPath: /config
              name: application-config
              readOnly: true
      volumes:
          # Tên ở phần "volumes.name" phải giống với "volumeMounts.name".
        - name: application-config
          configMap:
            name: students-cm

            # Sử dụng trường "items" này để mô tả cụ thể file bên trong ConfigMap sẽ được mounted và trong container.
            # Ở trường hợp này file "application.yaml" trong ConfigMap sẽ được mounted vào trong container.
            items:
            - key: application.yaml
              path: application.yaml
      restartPolicy: Always
```

Triển khai và lấy chi tiết ConfigMap trên Kubernetes:

```shell
# Triển khai ConfigMap
kubectl apply -f students-cm-volume.yaml
configmap/students-cm created

# Lấy danh sách ConfigMap
kubectl get cm
NAME                  DATA   AGE
students-cm           1      80m

# Lấy data cấu hình trong ConfigMap
kubectl describe cm/students-cm
Name:         students-cm
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
application.yaml:
----
server:
  port: 8080

spring:
  datasource:
    driverClassName: com.mysql.jdbc.Driver
    url: jdbc:mysql://mysql:3306/students
    username: students
    password: VNTechies2023
  jpa:
    hibernate.ddl-auto: update
    generate-ddl: true
    show-sql: false

BinaryData
====

Events:  <none>
```

Triển khai file cấu hình ứng dụng và lấy data được cấu hình trong ConfigMap được mounted vào container giống volume:

```shell
kubectl apply -f students-deployment-configmap-volume.yaml
deployment.apps/students-service created

# Lấy danh sach pods
kubectl get pods
NAME                              READY   STATUS    RESTARTS        AGE
students-service-f7cc674f-m7xqv   1/1     Running   0               86m
students-service-f7cc674f-nq8fc   1/1     Running   0               86m
students-service-f7cc674f-lzwg4   1/1     Running   0               86m

# File cấu hình trong configMap được đã được mounted vào folder "config" trong container
kubectl exec -it students-service-f7cc674f-nq8fc sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
bin  boot  config  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  workspace
# cd config
# ls
application.yaml
# cat application.yaml
server:
  port: 8080

spring:
  datasource:
    driverClassName: com.mysql.jdbc.Driver
    url: jdbc:mysql://mysql:3306/students
    username: students
    password: VNTechies2023
  jpa:
    hibernate.ddl-auto: update
    generate-ddl: true
    show-sql: false
```

Gọi API lấy các thông tin cấu hình ứng dụng:

```shell
kubectl port-forward po/students-service-f7cc674f-lzwg4 8080:8080

# Từ ứng dụng đã lấy được các thông tin cấu hình từ ConfigMap.
curl http://localhost:8080/api/configs/v1
AppConfigs{SERVER_PORT=8080, MYSQL_URL='jdbc:mysql://mysql:3306/students', MYSQL_USERNAME='students', MYSQL_PASSWORD='VNTechies2023'}
```

## 4. Tạo Secret và triển khai Secret trên Kubernetes
